@{
    ViewData["Title"] = "Close";
    string prevCcyRBU = Model.rbuItems.Count > 0 ? Model.rbuItems.OrderBy(x => x.ccy).ThenBy(x => x.expTrans).ToList()[0].ccy : "";
    string prevCcyFCDU = Model.fcduItems.Count > 0 ? Model.fcduItems.OrderBy(x => x.ccy).ThenBy(x => x.expTrans).ToList()[0].ccy : "";
    double totalAmount = 0;
    int totalTransCount = 0;
  //  int index = 0;
}

@using ExpenseProcessingSystem.ViewModels

@model ClosingViewModel

<div class="tab-content-cont m-t-10" id="closeBody">
    <div class="flex-c">
        <div id="tbl-lbl" class="float-l"><p class="dis-inline-block">Date: @Html.EditorFor(m => m.date, new { htmlAttributes = new { @class = "input", @type = "date", @readonly = "readonly" } })</p></div>
        <div class="float-l">
            @if (Model.fcduStatus == "CLOSED" && Model.rbuStatus == "CLOSED")
            {
                <button class="tbl-btn dis-inline-block" id="openBook" value="openBook">Open Daily Book</button>
            }
            else
            {
                <button class="tbl-btn dis-inline-block" disabled>Open Daily Book</button>
            }
        </div>
    </div>
    <br />
    <div class="tbl-cont m-b-20">
        <table class="table table-striped tab-tbl m-b-20">
            <thead>
                <tr>
                    <th>Tran Type</th>
                    <th>GBase Trans #</th>
                    <th>Express Trans #</th>
                    <th>Particulars</th>
                    <th>CCY</th>
                    <th>Amount</th>
                    <th>Trans Count</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.rbuItems.OrderBy(x => x.ccy).ThenBy(x => x.expTrans).ToList())
                {
                    if (prevCcyRBU == item.ccy)
                    {
                        totalAmount += item.amount;
                        totalTransCount += item.transCount;
                        <tr>
                            <td>RBU</td>
                            <td>@item.gBaseTrans</td>
                            <td>@item.expTrans</td>
                            <td>@item.particulars</td>
                            <td>@item.ccy</td>
                            <td>@item.amount</td>
                            <td>@item.transCount</td>
                            <td>@item.status</td>
                        </tr>
                        prevCcyRBU = item.ccy;
                    }
                    else
                    {
                        <tr class="totalStyle">
                            <td colspan="4">RBU TOTAL</td>
                            <td>@prevCcyRBU</td>
                            <td>@totalAmount</td>
                            <td>@totalTransCount</td>
                            <td></td>
                        </tr>

                        totalAmount = item.amount;
                        totalTransCount = item.transCount;
                        <tr>
                            <td>RBU</td>
                            <td>@item.gBaseTrans</td>
                            <td>@item.expTrans</td>
                            <td>@item.particulars</td>
                            <td>@item.ccy</td>
                            <td>@item.amount</td>
                            <td>@item.transCount</td>
                            <td>@item.status</td>
                        </tr>
                        prevCcyRBU = item.ccy;
                    }
                }
                <tr class="totalStyle">
                    <td colspan="4">RBU TOTAL</td>
                    <td>@prevCcyRBU</td>
                    <td>@totalAmount</td>
                    <td>@totalTransCount</td>
                    <td></td>
                </tr>
            </tbody>
        </table>

        <div class="tbl-controls m-t-20">
            <button value="CloseRBU" class="tbl-btn float-l closeBtn">Close RBU</button>
            <button value="reOpenRBU" class="tbl-btn float-l closeBtn">Re-Open RBU</button>
            <!--<button class="tbl-btn float-l">Print RBU Balance</button>-->
            <!--<button class="tbl-btn float-r">Print RBU Proof sheet</button>-->
        </div>

        <div id="tbl-lbl">
            <div class="dis-inline-block"><p>Status:</p></div>
            <div class="dis-inline-block">@Html.TextBoxFor(x=>x.rbuStatus,new { @readonly = "true" })</div>
        </div>

    </div>

    @{
        totalAmount = 0;
        totalTransCount = 0;
    }
    <div class="tbl-cont m-t-20 m-b-20">
        <table class="table table-striped tab-tbl m-b-20">
            <thead>
                <tr>
                    <th>Tran Type</th>
                    <th>GBase Trans #</th>
                    <th>Express Trans #</th>
                    <th>Particulars</th>
                    <th>CCY</th>
                    <th>Amount</th>
                    <th>Trans Count</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.fcduItems.OrderBy(x => x.ccy).ThenBy(x => x.expTrans).ToList())
                {
                    if (prevCcyFCDU == item.ccy)
                    {
                        totalAmount += item.amount;
                        totalTransCount += item.transCount;
                        <tr>
                            <td>FCDU</td>
                            <td>@item.gBaseTrans</td>
                            <td>@item.expTrans</td>
                            <td>@item.particulars</td>
                            <td>@item.ccy</td>
                            <td>@item.amount.ToString("0.00")</td>
                            <td>@item.transCount</td>
                            <td>@item.status</td>
                        </tr>
                        prevCcyFCDU = item.ccy;
                    }
                    else
                    {
                        <tr class="totalStyle">
                            <td colspan="4">FCDU TOTAL</td>
                            <td>@prevCcyFCDU</td>
                            <td>@totalAmount.ToString("0.00")</td>
                            <td>@totalTransCount</td>
                            <td></td>
                        </tr>

                        totalAmount = item.amount;
                        totalTransCount = item.transCount;
                        <tr>
                            <td>FCDU</td>
                            <td>@item.gBaseTrans</td>
                            <td>@item.expTrans</td>
                            <td>@item.particulars</td>
                            <td>@item.ccy</td>
                            <td>@item.amount.ToString("0.00")</td>
                            <td>@item.transCount</td>
                            <td>@item.status</td>
                        </tr>
                        prevCcyFCDU = item.ccy;
                    }
                }
                <tr class="totalStyle">
                    <td colspan="4">FCDU TOTAL</td>
                    <td>@prevCcyFCDU</td>
                    <td>@totalAmount.ToString("0.00")</td>
                    <td>@totalTransCount</td>
                    <td></td>
                </tr>
            </tbody>
        </table>

        <div class="tbl-controls m-t-20 m-b-20">
            <button value="CloseFCDU" class="tbl-btn float-l closeBtn">Close FCDU</button>
            <button value="reOpenFCDU" class="tbl-btn float-l closeBtn">Re-Open FCDU</button>
        </div>

        <div id="tbl-lbl">
            <div class="dis-inline-block"><p>Status:</p></div>
            <div class="dis-inline-block">@Html.TextBoxFor(x => x.fcduStatus, new { @readonly = "true" })</div>
        </div>
    </div>
    <hr class="dotted" />
    <div id="tbl-lbl"><h4 style="font-weight:bold;">Petty Cash Balance:</h4></div>
    <br />
    <table class="table" id="close-tbl">
        <colgroup>
            <col style="width:10%;" />
            <col style="width:15%;" />
            <col />
        </colgroup>
        <tbody>
            <tr>
                <td>
                    <p>Beginning Balance</p>
                </td>
                <td>
                    @Html.EditorFor(x=>x.pettyBegBalance, new { @readonly = "readonly"})
                </td>
                <td>
                    <button class="tbl-btn" id="StartPettyCash" value="StartPettyCash">Beginning Cash balance Confirmation</button>
                </td>
            </tr>
            <tr>
                <td>
                    <p>Cash-IN</p>
                </td>
                <td>
                    @Html.EditorFor(x=>x.recieve, new { @readonly = "readonly" })
                </td>
                <td><button class="tbl-btn" id="ClosePettyCash" value="ClosePettyCash">Petty Cash Breakdown</button></td>
            </tr>
            <tr>
                <td>
                    <p>Cash-OUT</p>
                </td>
                <td>
                    @Html.EditorFor(x=>x.Disbursed, new { @readonly = "readonly" })
                </td>
                <td>
                    <button class="tbl-btn" value="Close">Close</button>
                </td>
            </tr>
            <tr>
                <td>
                    <p>Ending Balance</p>
                </td>
                <td>
                    @Html.EditorFor(x=>x.closeBal, new { @readonly = "readonly" })
                </td>
                <td></td>
            </tr>
        </tbody>
    </table>
</div>
<div id="pettyCashModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="vertical-alignment-helper">
            <div class="modal-dialog vertical-align-center">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 style="display:inline">Cash Break Down</h4>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body">

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn float-r" data-dismiss="modal">Close</button>
                        <button class="btn float-r comVar" id="loginSubmit">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="login" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="vertical-alignment-helper">
            <div class="modal-dialog vertical-align-center">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 style="display:inline">Login</h4>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <table style="margin:5px;">
                            <tr>
                                <td>Username : </td>
                                <td>&nbsp;<input type="text" id="userName" class="input" /></td>
                            </tr>
                            <tr>
                                <td>&nbsp;&nbsp;</td>
                            </tr>
                            <tr>
                                <td>Password : </td>
                                <td>&nbsp;<input type="password" id="passWord" class="input" /></td>
                            </tr>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn float-r" data-dismiss="modal">Close</button>
                        <button class="btn float-r comVar" id="loginSubmit">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@using (Html.BeginForm("Close", "Home", FormMethod.Post, new { @id = "inputForm" }))
{
    <input type="hidden" name="command" id="cmdString" />
    <input type="hidden" name="username" id="userString" />
    <input type="hidden" name="password" id="passString" />
}
@Html.Partial("PopupMessage")
    <script type="text/javascript">
    $(function () {
         $(window).on("load", function () {
        @if (Model.messages.Count() > 0)
        {
            <text>
                $('#alert').text("@Model.messages[0]");
                $('#divcss').show();
            </text>
        }
        });

        $("#closeBody").on("click", "#StartPettyCash", function (e) {
            var command = $(this).val();
            $("#pettyCashModal").find(".modal-body").empty();
            $("#pettyCashModal").find(".modal-body").load("@Url.Action("ClosePettyCash", "Modal")", { command : command}, function (response, status, xhr) {
                if (status == "error") {
                    alert("Something went wrong.");
                }
            });
            $('#pettyCashModal').modal('show');
        });

        $("#closeBody").on("click", "#ClosePettyCash", function (e) {
            var command = $(this).val();
            $("#pettyCashModal").find(".modal-body").empty();
            $("#pettyCashModal").find(".modal-body").load("@Url.Action("ClosePettyCash", "Modal")", { command: command }, function (response, status, xhr) {
                if (status == "error") {
                    alert("Something went wrong.");
                }
            });
            $('#pettyCashModal').modal('show');
        });

        $("#closeBody").on("click", ".closeBtn", function (e) {
            $("#cmdString").val($(this).val());
            $('#login').modal('show');
        });

        $("#closeBody").on("click", "#openBook", function (e) {
            $("#cmdString").val($(this).val());
            $("#userString").val("-");
            $("#passString").val("-");
            $("#inputForm").submit();
        });

        $("#login").on("click", "#loginSubmit", function (e) {
            $("#userString").val($("#userName").val());
            $("#passString").val($("#passWord").val());
            $("#inputForm").submit();
        });
    });
    </script>
